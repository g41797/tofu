
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://g41797.github.io/tofu/mds/specification/">
      
      
        <link rel="prev" href="../conversation/">
      
      
        <link rel="next" href="../tofu-implementation-review/">
      
      
        
      
      
      <link rel="icon" href="../../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Specification - Tofu - Sync your devs, Async your apps!</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      
  
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1%207.775V2.75C1%201.784%201.784%201%202.75%201h5.025c.464%200%20.91.184%201.238.513l6.25%206.25a1.75%201.75%200%200%201%200%202.474l-5.026%205.026a1.75%201.75%200%200%201-2.474%200l-6.25-6.25A1.75%201.75%200%200%201%201%207.775m1.5%200c0%20.066.026.13.073.177l6.25%206.25a.25.25%200%200%200%20.354%200l5.025-5.025a.25.25%200%200%200%200-.354l-6.25-6.25a.25.25%200%200%200-.177-.073H2.75a.25.25%200%200%200-.25.25ZM6%205a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.5%201.75v11.5c0%20.138.112.25.25.25h3.17a.75.75%200%200%201%200%201.5H2.75A1.75%201.75%200%200%201%201%2013.25V1.75C1%20.784%201.784%200%202.75%200h8.5C12.216%200%2013%20.784%2013%201.75v7.736a.75.75%200%200%201-1.5%200V1.75a.25.25%200%200%200-.25-.25h-8.5a.25.25%200%200%200-.25.25m13.274%209.537zl-4.557%204.45a.75.75%200%200%201-1.055-.008l-1.943-1.95a.75.75%200%200%201%201.062-1.058l1.419%201.425%204.026-3.932a.75.75%200%201%201%201.048%201.074M4.75%204h4.5a.75.75%200%200%201%200%201.5h-4.5a.75.75%200%200%201%200-1.5M4%207.75A.75.75%200%200%201%204.75%207h2a.75.75%200%200%201%200%201.5h-2A.75.75%200%200%201%204%207.75%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.5%207.75A.75.75%200%200%201%207.25%207h1a.75.75%200%200%201%20.75.75v2.75h.25a.75.75%200%200%201%200%201.5h-2a.75.75%200%200%201%200-1.5h.25v-2h-.25a.75.75%200%200%201-.75-.75M8%206a1%201%200%201%201%200-2%201%201%200%200%201%200%202%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M3.499.75a.75.75%200%200%201%201.5%200v.996C5.9%202.903%206.793%203.65%207.662%204.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873%2010.794-.045%2012.622.26%2014.408.558%2016%201.94%2016%204.25c0%201.278-.954%202.575-2.44%202.734l.146.508.065.22c.203.701.412%201.455.476%202.226.142%201.707-.4%203.03-1.487%203.898C11.714%2014.671%2010.27%2015%208.75%2015h-6a.75.75%200%200%201%200-1.5h1.376a4.5%204.5%200%200%201-.563-1.191%203.84%203.84%200%200%201-.05-2.063%204.65%204.65%200%200%201-2.025-.293.75.75%200%200%201%20.525-1.406c1.357.507%202.376-.006%202.698-.318l.009-.01a.747.747%200%200%201%201.06%200%20.75.75%200%200%201-.012%201.074c-.912.92-.992%201.835-.768%202.586.221.74.745%201.337%201.196%201.621H8.75c1.343%200%202.398-.296%203.074-.836.635-.507%201.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.4%202.4%200%200%201-.507-.441%203.1%203.1%200%200%201-.633-1.248.75.75%200%200%201%201.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738%200%201.25-.615%201.25-1.25%200-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706%201.345-.46.92-.27%201.774.019%203.062l.042.19.01.05c.348.443.666.949.94%201.553a.75.75%200%201%201-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7%205.527c-.814-.68-1.75-1.462-2.692-2.619a3.7%203.7%200%200%200-1.023.88c-.406.495-.663%201.036-.722%201.508.116.122.306.21.591.239.388.038.797-.06%201.032-.19a.75.75%200%200%201%20.728%201.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75%205.677V5.5c0-.984.48-1.94%201.077-2.664.46-.559%201.05-1.055%201.673-1.353z%22/%3E%3C/svg%3E');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M13.78%204.22a.75.75%200%200%201%200%201.06l-7.25%207.25a.75.75%200%200%201-1.06%200L2.22%209.28a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018L6%2010.94l6.72-6.72a.75.75%200%200%201%201.06%200%22/%3E%3C/svg%3E');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.92%206.085h.001a.749.749%200%201%201-1.342-.67c.169-.339.436-.701.849-.977C6.845%204.16%207.369%204%208%204a2.76%202.76%200%200%201%201.637.525c.503.377.863.965.863%201.725%200%20.448-.115.83-.329%201.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6%206%200%200%200-.26.16%201%201%200%200%200-.276.245.75.75%200%200%201-1.248-.832c.184-.264.42-.489.692-.661q.154-.1.313-.195l.007-.004c.1-.061.182-.11.258-.161a1%201%200%200%200%20.277-.245C8.96%206.514%209%206.427%209%206.25a.61.61%200%200%200-.262-.525A1.27%201.27%200%200%200%208%205.5c-.369%200-.595.09-.74.187a1%201%200%200%200-.34.398M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M6.457%201.047c.659-1.234%202.427-1.234%203.086%200l6.082%2011.378A1.75%201.75%200%200%201%2014.082%2015H1.918a1.75%201.75%200%200%201-1.543-2.575Zm1.763.707a.25.25%200%200%200-.44%200L1.698%2013.132a.25.25%200%200%200%20.22.368h12.164a.25.25%200%200%200%20.22-.368Zm.53%203.996v2.5a.75.75%200%200%201-1.5%200v-2.5a.75.75%200%200%201%201.5%200M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.344%202.343za8%208%200%200%201%2011.314%2011.314A8.002%208.002%200%200%201%20.234%2010.089a8%208%200%200%201%202.11-7.746m1.06%2010.253a6.5%206.5%200%201%200%209.108-9.275%206.5%206.5%200%200%200-9.108%209.275M6.03%204.97%208%206.94l1.97-1.97a.749.749%200%200%201%201.275.326.75.75%200%200%201-.215.734L9.06%208l1.97%201.97a.749.749%200%200%201-.326%201.275.75.75%200%200%201-.734-.215L8%209.06l-1.97%201.97a.749.749%200%200%201-1.275-.326.75.75%200%200%201%20.215-.734L6.94%208%204.97%206.03a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M9.504.43a1.516%201.516%200%200%201%202.437%201.713L10.415%205.5h2.123c1.57%200%202.346%201.909%201.22%203.004l-7.34%207.142a1.25%201.25%200%200%201-.871.354h-.302a1.25%201.25%200%200%201-1.157-1.723L5.633%2010.5H3.462c-1.57%200-2.346-1.909-1.22-3.004zm1.047%201.074L3.286%208.571A.25.25%200%200%200%203.462%209H6.75a.75.75%200%200%201%20.694%201.034l-1.713%204.188%206.982-6.793A.25.25%200%200%200%2012.538%207H9.25a.75.75%200%200%201-.683-1.06l2.008-4.418.003-.006-.004-.009-.006-.006-.008-.001q-.005%200-.009.004%22/%3E%3C/svg%3E');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M4.72.22a.75.75%200%200%201%201.06%200l1%20.999a3.5%203.5%200%200%201%202.441%200l.999-1a.748.748%200%200%201%201.265.332.75.75%200%200%201-.205.729l-.775.776c.616.63.995%201.493.995%202.444v.327q0%20.15-.025.292c.408.14.764.392%201.029.722l1.968-.787a.75.75%200%200%201%20.556%201.392L13%207.258V9h2.25a.75.75%200%200%201%200%201.5H13v.5q-.002.615-.141%201.186l2.17.868a.75.75%200%200%201-.557%201.392l-2.184-.873A5%205%200%200%201%208%2016a5%205%200%200%201-4.288-2.427l-2.183.873a.75.75%200%200%201-.558-1.392l2.17-.868A5%205%200%200%201%203%2011v-.5H.75a.75.75%200%200%201%200-1.5H3V7.258L.971%206.446a.75.75%200%200%201%20.558-1.392l1.967.787c.265-.33.62-.583%201.03-.722a1.7%201.7%200%200%201-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72%201.28a.75.75%200%200%201%200-1.06m.53%206.28a.75.75%200%200%200-.75.75V11a3.5%203.5%200%201%200%207%200V7.25a.75.75%200%200%200-.75-.75ZM6.173%205h3.654A.17.17%200%200%200%2010%204.827V4.5a2%202%200%201%200-4%200v.327c0%20.096.077.173.173.173%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5%205.782V2.5h-.25a.75.75%200%200%201%200-1.5h6.5a.75.75%200%200%201%200%201.5H11v3.282l3.666%205.76C15.619%2013.04%2014.543%2015%2012.767%2015H3.233c-1.776%200-2.852-1.96-1.899-3.458Zm-2.4%206.565a.75.75%200%200%200%20.633%201.153h9.534a.75.75%200%200%200%20.633-1.153L12.225%2010.5h-8.45ZM9.5%202.5h-3V6c0%20.143-.04.283-.117.403L4.73%209h6.54L9.617%206.403A.75.75%200%200%201%209.5%206Z%22/%3E%3C/svg%3E');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1.75%202.5h10.5a.75.75%200%200%201%200%201.5H1.75a.75.75%200%200%201%200-1.5m4%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5m0%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5M2.5%207.75v6a.75.75%200%200%201-1.5%200v-6a.75.75%200%200%201%201.5%200%22/%3E%3C/svg%3E');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#project-architecture-implementation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Tofu - Sync your devs, Async your apps!" class="md-header__button md-logo" aria-label="Tofu - Sync your devs, Async your apps!" data-md-component="logo">
      
  <img src="../../assets/Ziggy_And_Zero_Are_Cooking_Tofu.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tofu - Sync your devs, Async your apps!
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Specification
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/g41797/tofu/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    tofu on GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Tofu - Sync your devs, Async your apps!" class="md-nav__button md-logo" aria-label="Tofu - Sync your devs, Async your apps!" data-md-component="logo">
      
  <img src="../../assets/Ziggy_And_Zero_Are_Cooking_Tofu.png" alt="logo">

    </a>
    Tofu - Sync your devs, Async your apps!
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/g41797/tofu/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    tofu on GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mantra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mantra
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Implementation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Implementation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../imports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Imports
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../key-ingredients/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ingredients
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ampe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ampe
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../statuses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Errors and Statuses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../channel-group/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ChannelGroup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Message
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Message
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../message/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configurators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configurators
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../for-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Addendum
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Addendum
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../naq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sockets101/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sockets 101
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../allocator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Allocator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../coding-style/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coding style
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callback-enabled/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Callback enabled
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    AI generated docs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    AI generated docs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aigenerated/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About AI Generated Documents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tofu-quick-reference-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tofu-philosophy-and-advantages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tofu-message-patterns-and-recipes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recipes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conversation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Conversation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Specification
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Specification
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#11-high-level-philosophy" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 High-Level Philosophy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 High-Level Philosophy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Principles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-message-as-cube-metaphor" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Message-as-Cube Metaphor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-tofu-provides" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Tofu Provides
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-tofu-does-not-provide" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Tofu Does NOT Provide
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-system-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 System Architecture
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 System Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#top-level-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Top-Level Components
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#component-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Component Responsibilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-message-structure-core-data-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Message Structure (Core Data Type)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 Message Structure (Core Data Type)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#message-anatomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message Anatomy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Anatomy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-persistent-fields-transmitted-over-wire" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 1: Persistent Fields (Transmitted Over Wire)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-transient-fields-not-transmitted" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 2: Transient Fields (NOT Transmitted)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-3-intrusive-list-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 3: Intrusive List Nodes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message Validation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-reactor-pattern-event-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 Reactor Pattern (Event Loop)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.4 Reactor Pattern (Event Loop)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reactor-thread-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reactor Thread Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reactor-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reactor Components
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reactor-event-loop-pseudocode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reactor Event Loop Pseudocode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connection State Machine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-memory-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.5 Memory Management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.5 Memory Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pool-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pool Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-ownership-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Ownership Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocator-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocator Usage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-concurrency-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.6 Concurrency Model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.6 Concurrency Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#threading-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Threading Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-safety-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Thread-Safety Table
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mutex-inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mutex Inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mailbox-communication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mailbox Communication
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomic-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Atomic Operations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-io-and-networking" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.7 I/O and Networking
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.7 I/O and Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#non-blocking-socket-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Blocking Socket Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poller-abstraction-pollerzig" class="md-nav__link">
    <span class="md-ellipsis">
      
        Poller Abstraction (poller.zig)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocol-wire-format" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protocol Wire Format
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#socket-io-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Socket I/O State Machine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcp-vs-unix-domain-sockets" class="md-nav__link">
    <span class="md-ellipsis">
      
        TCP vs Unix Domain Sockets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-os-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.8 OS Dependencies
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.8 OS Dependencies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#posix-system-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        POSIX System Calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-library-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        External Library Dependencies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-entity-catalog-and-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.9 Entity Catalog and Responsibilities
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.9 Entity Catalog and Responsibilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-entities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Entities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#public-api-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        Public API Interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recipe Patterns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#110-architectural-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.10 Architectural Flows
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.10 Architectural Flows">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flow-1-server-startup-and-client-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 1: Server Startup and Client Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-2-message-exchange-request-response" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 2: Message Exchange (Request-Response)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-3-pool-empty-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 3: Pool Empty Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-4-inter-thread-communication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 4: Inter-Thread Communication
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tofu-implementation-review/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Review
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#11-high-level-philosophy" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 High-Level Philosophy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 High-Level Philosophy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Principles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-message-as-cube-metaphor" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Message-as-Cube Metaphor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-tofu-provides" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Tofu Provides
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-tofu-does-not-provide" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Tofu Does NOT Provide
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-system-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 System Architecture
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 System Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#top-level-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Top-Level Components
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#component-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Component Responsibilities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-message-structure-core-data-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Message Structure (Core Data Type)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 Message Structure (Core Data Type)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#message-anatomy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message Anatomy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Anatomy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-persistent-fields-transmitted-over-wire" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 1: Persistent Fields (Transmitted Over Wire)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-transient-fields-not-transmitted" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 2: Transient Fields (NOT Transmitted)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-3-intrusive-list-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 3: Intrusive List Nodes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message Validation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-reactor-pattern-event-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 Reactor Pattern (Event Loop)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.4 Reactor Pattern (Event Loop)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reactor-thread-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reactor Thread Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reactor-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reactor Components
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reactor-event-loop-pseudocode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reactor Event Loop Pseudocode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connection State Machine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-memory-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.5 Memory Management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.5 Memory Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pool-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pool Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-ownership-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Ownership Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocator-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocator Usage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-concurrency-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.6 Concurrency Model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.6 Concurrency Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#threading-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Threading Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-safety-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Thread-Safety Table
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mutex-inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mutex Inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mailbox-communication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mailbox Communication
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomic-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Atomic Operations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-io-and-networking" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.7 I/O and Networking
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.7 I/O and Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#non-blocking-socket-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Blocking Socket Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poller-abstraction-pollerzig" class="md-nav__link">
    <span class="md-ellipsis">
      
        Poller Abstraction (poller.zig)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocol-wire-format" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protocol Wire Format
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#socket-io-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Socket I/O State Machine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcp-vs-unix-domain-sockets" class="md-nav__link">
    <span class="md-ellipsis">
      
        TCP vs Unix Domain Sockets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-os-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.8 OS Dependencies
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.8 OS Dependencies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#posix-system-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        POSIX System Calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-library-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        External Library Dependencies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-entity-catalog-and-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.9 Entity Catalog and Responsibilities
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.9 Entity Catalog and Responsibilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-entities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Entities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#public-api-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        Public API Interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recipe-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recipe Patterns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#110-architectural-flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.10 Architectural Flows
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.10 Architectural Flows">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flow-1-server-startup-and-client-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 1: Server Startup and Client Connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-2-message-exchange-request-response" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 2: Message Exchange (Request-Response)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-3-pool-empty-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 3: Pool Empty Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-4-inter-thread-communication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow 4: Inter-Thread Communication
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Home
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../aigenerated/" class="md-path__link">
          
  <span class="md-ellipsis">
    AI generated docs
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="project-architecture-implementation">PROJECT ARCHITECTURE &amp; IMPLEMENTATION</h1>
<p>This section describes the tofu project comprehensively, independent of porting concerns.</p>
<hr />
<h2 id="11-high-level-philosophy">1.1 High-Level Philosophy</h2>
<h3 id="core-principles">Core Principles</h3>
<p><strong>1. "The Message is the API"</strong></p>
<ul>
<li>The data structure itself defines the communication contract</li>
<li>No complex API interfaces, RPC definitions, or service interfaces required upfront</li>
<li>The message structure IS the contract</li>
</ul>
<p><strong>2. "Gradual Evolution"</strong></p>
<ul>
<li>Start with something simple and grow it into a powerful system over time</li>
<li>Begin with basic message exchange, then add complexity as needed</li>
</ul>
<p><strong>3. "Connect your developers. Then connect your applications."</strong></p>
<ul>
<li>Development starts with a <strong>conversation</strong> between developers, not with API specifications</li>
<li>See the S/R Dialog pattern in README.md for exemplar</li>
</ul>
<h3 id="the-message-as-cube-metaphor">The Message-as-Cube Metaphor</h3>
<p>As food, <strong>tofu</strong> is very simple and has almost no flavor on its own.
By using tofu <strong>cubes</strong>, you can:</p>
<ul>
<li>Eat it <strong>plain</strong> for a simple snack</li>
<li>Add a little <strong>spice</strong> to make it better</li>
<li>Create a <strong>culinary masterpiece</strong></li>
</ul>
<p>As a <strong>protocol</strong>, tofu uses <strong>messages</strong> like cubes.
By "cooking" these messages together, you can grow your project:</p>
<ul>
<li>Start with <strong>minimal setups</strong></li>
<li>Build <strong>complex flows</strong></li>
<li>Create full <strong>distributed applications</strong></li>
</ul>
<h3 id="what-tofu-provides">What Tofu Provides</h3>
<ul>
<li><strong>Foundation layer</strong> for asynchronous message passing</li>
<li><strong>Stream-oriented transport</strong> (TCP/IP and Unix Domain Sockets)</li>
<li><strong>Pool-based memory management</strong> with backpressure control</li>
<li><strong>Thread-safe APIs</strong> for multi-threaded applications</li>
<li><strong>Reactor pattern</strong> for efficient I/O multiplexing</li>
<li><strong>Peer-to-peer, full-duplex</strong> communication after handshake</li>
</ul>
<h3 id="what-tofu-does-not-provide">What Tofu Does NOT Provide</h3>
<ul>
<li>High-level serialization (JSON, Protobuf, etc.) - user chooses</li>
<li>Authentication/authorization - user implements</li>
<li>Load balancing, service discovery - user designs</li>
<li>Opinionated business logic patterns</li>
</ul>
<hr />
<h2 id="12-system-architecture">1.2 System Architecture</h2>
<h3 id="top-level-components">Top-Level Components</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>                    Application Layer                    
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  (User code using tofu API - Services, Clients, etc.)   
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                     
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a> 
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                  Public API Layer                        
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>              
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        Ampe                   ChannelGroup           
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>     Interface          Interface             
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>              
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                                                        
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                                                        
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                Message Pool                            
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    (Pool.zig - LIFO, mutex-protected)                  
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a> 
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                     
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>               Engine Layer (Reactor)                    
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>     Reactor         Notifier    ActiveChannels    
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    (Event Loop)   (socketpair)    (Registry)      
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                                                      
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>   
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>             Poller (poll/epoll/kqueue)                
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>   
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                            
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                    OS Layer                             
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>               
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    TCP Sockets                Unix Domain Sockets   
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    (non-blocking)               (non-blocking)      
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>               
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
</span></code></pre></div>
<h3 id="component-responsibilities">Component Responsibilities</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Responsibility</th>
<th>Thread Safety</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Ampe Interface</strong></td>
<td>Message pool operations (get/put), ChannelGroup lifecycle</td>
<td>Thread-safe (all methods)</td>
</tr>
<tr>
<td><strong>ChannelGroup Interface</strong></td>
<td>Message exchange (send/receive), receiver updates</td>
<td>Mixed (see threading model)</td>
</tr>
<tr>
<td><strong>Reactor</strong></td>
<td>Event loop, I/O multiplexing, message dispatch</td>
<td>Internal only (single thread)</td>
</tr>
<tr>
<td><strong>Pool</strong></td>
<td>Message lifecycle, allocation strategy, backpressure</td>
<td>Thread-safe (mutex)</td>
</tr>
<tr>
<td><strong>ActiveChannels</strong></td>
<td>Channel registry, random channel allocation, ownership validation</td>
<td>Thread-safe (mutex)</td>
</tr>
<tr>
<td><strong>Notifier</strong></td>
<td>Cross-thread notifications via socketpair</td>
<td>Thread-safe (producer-consumer)</td>
</tr>
<tr>
<td><strong>Poller</strong></td>
<td>OS-specific I/O polling abstraction</td>
<td>Internal only (Reactor thread)</td>
</tr>
<tr>
<td><strong>Message</strong></td>
<td>Data structure with header, text headers, body</td>
<td>User-managed (pool lifecycle)</td>
</tr>
<tr>
<td><strong>MchnGroup</strong></td>
<td>ChannelGroup implementation with dual mailboxes</td>
<td>Thread-safe (per interface spec)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="13-message-structure-core-data-type">1.3 Message Structure (Core Data Type)</h2>
<h3 id="message-anatomy">Message Anatomy</h3>
<p>Every message has <strong>three logical parts</strong>:</p>
<h4 id="part-1-persistent-fields-transmitted-over-wire">Part 1: Persistent Fields (Transmitted Over Wire)</h4>
<p><strong>BinaryHeader (16 bytes, packed, big-endian on wire):</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a> channel_number   proto         status   message_id     &lt;thl&gt;     &lt;bl&gt;    
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    (u16)         (ProtoFields)  (u8)      (u64)        (u16)     (u16)   
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    2 bytes         1 byte      1 byte     8 bytes      2 bytes   2 bytes 
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>Total: 16 bytes
</span></code></pre></div></p>
<p><strong>ProtoFields (8 bits packed):</strong></p>
<ul>
<li><code>mtype</code> (3 bits): Message type - <code>.welcome</code>, <code>.hello</code>, <code>.bye</code>, <code>.regular</code></li>
<li><code>role</code> (2 bits): Message role - <code>.request</code>, <code>.response</code>, <code>.signal</code></li>
<li><code>origin</code> (1 bit): Origin - <code>.application</code>, <code>.engine</code></li>
<li><code>more</code> (1 bit): More messages in sequence - <code>.last</code>, <code>.expected</code></li>
<li><code>oob</code> (1 bit): Out-of-band (priority) - <code>.off</code>, <code>.on</code></li>
</ul>
<p><strong>TextHeaders (Optional, HTTP-style key-value pairs):</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Key1: Value1\r\n
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Key2: Value2\r\n
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>\r\n
</span></code></pre></div>
<ul>
<li>Used for configuration (IP addresses, ports, paths)</li>
<li>Used for application metadata (job tickets, progress indicators, etc.)</li>
<li>Engine manages length in <code>&lt;thl&gt;</code> field</li>
<li>HTTP-like parsing with iterator</li>
</ul>
<p><strong>Body (Optional, application payload):</strong></p>
<ul>
<li>Appendable buffer (dynamically growing)</li>
<li>Engine does not interpret contents</li>
<li>Engine manages length in <code>&lt;bl&gt;</code> field</li>
<li>Can hold binary or text data</li>
</ul>
<h4 id="part-2-transient-fields-not-transmitted">Part 2: Transient Fields (NOT Transmitted)</h4>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="err">@</span><span class="s">&quot;&lt;void*&gt;&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="w">  </span><span class="c1">// Application-specific pointer (user can use)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="err">@</span><span class="s">&quot;&lt;ctx&gt;&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="w">    </span><span class="c1">// Engine-internal context pointer (engine uses)</span>
</span></code></pre></div>
<h4 id="part-3-intrusive-list-nodes">Part 3: Intrusive List Nodes</h4>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">prev</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">Message</span><span class="w">  </span><span class="c1">// Previous message in queue</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">next</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">Message</span><span class="w">  </span><span class="c1">// Next message in queue</span>
</span></code></pre></div>
<ul>
<li>Enables zero-allocation queuing via intrusive linked lists</li>
<li>Used by Pool, Mailboxes, and internal queues</li>
</ul>
<h3 id="message-lifecycle">Message Lifecycle</h3>
<pre class="mermaid"><code>stateDiagram-v2
    [*] --&gt; Pool: Initialize
    Pool --&gt; InUse: get() - Application acquires
    InUse --&gt; ConfiguredLocal: Set fields (bhdr, thdrs, body)
    ConfiguredLocal --&gt; Sent: enqueueToPeer() - Ownership transfers
    Sent --&gt; InFlight: Engine serializes &amp; sends
    InFlight --&gt; Received: Peer receives
    Received --&gt; Pool: put() - Application releases
    Pool --&gt; [*]: Shutdown

    note right of InUse
        Application owns message
        Must call put() via defer
    end note

    note right of Sent
        Message pointer becomes NULL
        Cannot be used after send
    end note

    note right of Received
        New message from pool
        Contains received data
    end note</code></pre>
<p><strong>Critical Ownership Rule:</strong> After <code>enqueueToPeer(&amp;msg)</code>, the message pointer becomes NULL. Application <strong>cannot</strong> use message after send. This prevents use-after-free bugs at compile time.</p>
<h3 id="message-validation">Message Validation</h3>
<p>Before sending, messages undergo validation via <code>check_and_prepare()</code>:</p>
<p><strong>Valid Combinations (ValidCombination enum):</strong></p>
<ol>
<li>
<p><strong>Welcome/Hello:</strong></p>
<ul>
<li><code>mtype</code>: <code>.welcome</code> or <code>.hello</code></li>
<li><code>role</code>: <code>.request</code> or <code>.response</code></li>
<li><code>channel_number</code>: Must be 0 (special)</li>
</ul>
</li>
<li>
<p><strong>Regular Request:</strong></p>
<ul>
<li><code>mtype</code>: <code>.regular</code></li>
<li><code>role</code>: <code>.request</code></li>
<li><code>channel_number</code>: Non-zero</li>
<li><code>message_id</code>: Auto-generated if 0</li>
</ul>
</li>
<li>
<p><strong>Regular Response:</strong></p>
<ul>
<li><code>mtype</code>: <code>.regular</code></li>
<li><code>role</code>: <code>.response</code></li>
<li><code>channel_number</code>: Non-zero</li>
<li><code>message_id</code>: <strong>Must</strong> be non-zero (matches request)</li>
</ul>
</li>
<li>
<p><strong>Regular Signal:</strong></p>
<ul>
<li><code>mtype</code>: <code>.regular</code></li>
<li><code>role</code>: <code>.signal</code></li>
<li><code>channel_number</code>: Non-zero</li>
<li><code>message_id</code>: Auto-generated if 0</li>
</ul>
</li>
<li>
<p><strong>Bye:</strong></p>
<ul>
<li><code>mtype</code>: <code>.bye</code></li>
<li><code>role</code>: <code>.request</code>, <code>.response</code>, or <code>.signal</code></li>
<li><code>channel_number</code>: Non-zero</li>
</ul>
</li>
</ol>
<p><strong>Validation Checks:</strong></p>
<ul>
<li>Headers length fits in u16 (<code>&lt;thl&gt;</code>)</li>
<li>Body length fits in u16 (<code>&lt;bl&gt;</code>)</li>
<li>Type/role combination is valid</li>
<li>Channel number constraints respected</li>
<li>Response has non-zero message_id</li>
</ul>
<hr />
<h2 id="14-reactor-pattern-event-loop">1.4 Reactor Pattern (Event Loop)</h2>
<h3 id="reactor-thread-lifecycle">Reactor Thread Lifecycle</h3>
<pre class="mermaid"><code>stateDiagram-v2
    [*] --&gt; Creating: Reactor.Create()
    Creating --&gt; Initializing: Allocate structures
    Initializing --&gt; Starting: Spawn reactor thread
    Starting --&gt; Polling: Enter event loop

    Polling --&gt; Processing: Events detected
    Processing --&gt; SendMessages: Process send queue
    SendMessages --&gt; ReceiveMessages: Process socket reads
    ReceiveMessages --&gt; HandleNotifications: Check notifier
    HandleNotifications --&gt; Polling: Continue loop

    Polling --&gt; ShuttingDown: Shutdown signal
    ShuttingDown --&gt; Cleanup: Close sockets, free resources
    Cleanup --&gt; [*]: Thread exits

    note right of Polling
        poll/epoll/kqueue waits for:
        - Socket readable
        - Socket writable
        - Notifier event
    end note

    note right of Processing
        Single-threaded:
        - No locks needed
        - Sequential processing
    end note</code></pre>
<h3 id="reactor-components">Reactor Components</h3>
<p><strong>1. Poller (poller.zig)</strong></p>
<ul>
<li>Abstraction over OS-specific polling mechanisms</li>
<li>Linux: <code>epoll</code> (epoll_create1, epoll_ctl, epoll_wait)</li>
<li>BSD/macOS: <code>kqueue</code> (kqueue, kevent)</li>
<li>Fallback: <code>poll</code> (poll syscall)</li>
<li>Manages file descriptor interest registration</li>
<li>Returns triggered sockets on each poll cycle</li>
</ul>
<p><strong>2. TriggeredChannels (triggeredSkts.zig)</strong></p>
<ul>
<li>Maps socket fd  channel number</li>
<li>Stores which channels have I/O events</li>
<li>Read events vs. Write events tracking</li>
<li>Cleared each poll cycle</li>
</ul>
<p><strong>3. Notifier (Notifier.zig)</strong></p>
<ul>
<li><strong>Purpose:</strong> Wake reactor thread from blocking poll</li>
<li><strong>Mechanism:</strong> Socketpair (or UDS on Linux)<ul>
<li>Sender socket: Application threads write to this</li>
<li>Receiver socket: Reactor thread polls this</li>
</ul>
</li>
<li><strong>Notification Types:</strong><ul>
<li><code>message</code>: New message to send (from mailbox)</li>
<li><code>alert</code>: Pool freed memory or shutdown started</li>
</ul>
</li>
<li><strong>Format:</strong> 8-bit packed notification<ul>
<li><code>kind</code> (1 bit): message vs alert</li>
<li><code>oob</code> (1 bit): out-of-band flag</li>
<li><code>vc</code> (4 bits): ValidCombination hint</li>
<li><code>at</code> (2 bits): AlertType (pool freed, shutdown, etc.)</li>
</ul>
</li>
</ul>
<p><strong>4. Mailboxes (dual MSGMailBox)</strong></p>
<ul>
<li><strong>Structure:</strong> Two intrusive mailboxes per MchnGroup<ul>
<li><code>msgs[0]</code>: Send queue (app  engine)</li>
<li><code>msgs[1]</code>: Receive queue (engine  app)</li>
</ul>
</li>
<li><strong>Implementation:</strong> Intrusive queue (MailBoxIntrusive from external library)</li>
<li><strong>Thread Safety:</strong> Lock-free producer-consumer pattern</li>
<li><strong>Blocking:</strong> <code>send()</code> and <code>receive()</code> can block/timeout</li>
</ul>
<p><strong>5. ActiveChannels (channels.zig)</strong></p>
<ul>
<li><strong>Purpose:</strong> Registry of all active channels</li>
<li><strong>Channel Allocation:</strong> Random u16 (excluding 0 and u16::MAX)<ul>
<li>Avoids sequential predictability</li>
<li>Circular buffer tracks recently removed channels (prevents immediate reuse)</li>
</ul>
</li>
<li><strong>Validation:</strong> <code>check()</code> method ensures channel belongs to correct ChannelGroup</li>
<li><strong>Thread Safety:</strong> Mutex-protected</li>
<li><strong>Data Structure:</strong> <code>std.AutoArrayHashMap(ChannelNumber, ActiveChannel)</code><ul>
<li>ActiveChannel contains: channel number, message_id, proto fields, context pointer</li>
</ul>
</li>
</ul>
<h3 id="reactor-event-loop-pseudocode">Reactor Event Loop Pseudocode</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>function reactorLoop():
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    while not shutdown:
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>        // 1. Poll for I/O events (with timeout)
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        triggered_sockets = poller.poll(timeout_ms)
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        // 2. Process notifier events first (highest priority)
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>        if notifier.receiver in triggered_sockets:
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>            notification = notifier.readNotification()
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>            if notification.kind == shutdown:
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                shutdown = true
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                continue
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>            if notification.kind == alert:
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                handlePoolAlert()
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        // 3. Process send queue (messages from application)
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        while sendMailbox.hasMessages():
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>            msg = sendMailbox.dequeue()
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            if msg.isHelloOrWelcome():
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>                handleConnectionRequest(msg)
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>            else if msg.isBye():
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>                handleDisconnection(msg)
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>            else:
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>                enqueueForSocketWrite(msg)
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        // 4. Process writable sockets (send pending data)
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        for each socket in triggered_sockets where writable:
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            if hasDataToSend(socket):
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>                bytesSent = socket.send(data)
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>                if fully_sent:
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>                    removePendingSend(socket)
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        // 5. Process readable sockets (receive data)
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        for each socket in triggered_sockets where readable:
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>            if socket.isListener():
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>                newClient = socket.accept()
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>                sendHelloToApp(newClient)
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>            else:
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>                data = socket.receive()
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>                msg = parseMessage(data)
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>                receiveMailbox.enqueue(msg)
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>                notifyApplication()  // Wake waitReceive()
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>        // 6. Handle socket errors
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        for each socket in triggered_sockets where error:
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>            sendChannelClosedStatus(socket.channel)
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>            closeSocket(socket)
</span></code></pre></div>
<h3 id="connection-state-machine">Connection State Machine</h3>
<pre class="mermaid"><code>stateDiagram-v2
    [*] --&gt; WelcomeRequest: Server sends (ch=0)
    WelcomeRequest --&gt; Listening: Engine creates listener
    Listening --&gt; WelcomeResponse: Success/Error status

    [*] --&gt; HelloRequest: Client sends (ch=0)
    HelloRequest --&gt; Connecting: Engine connects socket
    Connecting --&gt; HelloSent: TCP handshake complete
    HelloSent --&gt; WaitHelloResponse: Sent on wire

    Listening --&gt; NewConnection: accept() returns
    NewConnection --&gt; AssignChannel: Random ch# generated
    AssignChannel --&gt; HelloReceived: Send to app
    HelloReceived --&gt; HelloResponseSent: App responds

    WaitHelloResponse --&gt; Connected: Receive HelloResponse
    HelloResponseSent --&gt; Connected: Both peers ready

    Connected --&gt; RegularMessaging: Exchange messages
    RegularMessaging --&gt; Connected: Continue

    Connected --&gt; ByeRequest: Graceful close
    ByeRequest --&gt; ByeResponse: Peer confirms
    ByeResponse --&gt; ChannelClosed: Clean shutdown

    Connected --&gt; ByeSignal: Force close (oob=on)
    ByeSignal --&gt; ChannelClosed: Immediate

    Connected --&gt; SocketError: Network failure
    SocketError --&gt; ChannelClosed: Send error status

    ChannelClosed --&gt; [*]</code></pre>
<hr />
<h2 id="15-memory-management">1.5 Memory Management</h2>
<h3 id="pool-architecture">Pool Architecture</h3>
<p><strong>Design Pattern:</strong> LIFO (Last In, First Out) pool for cache locality</p>
<p><strong>Structure (Pool.zig):</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Pool {
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    allocator: Allocator           // GPA-compatible allocator
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    mutex: Mutex                   // Thread-safe access
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    first: ?*Message               // Head of LIFO stack
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    closed: bool                   // Pool shutdown flag
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    current: usize                 // Current pool size
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    high: usize                    // High-water mark
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    alerter: Alerter               // Callback to notify engine
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>}
</span></code></pre></div></p>
<p><strong>Operations:</strong></p>
<ol>
<li>
<p><strong>get(strategy: AllocationStrategy)  ?*Message</strong></p>
<ul>
<li>Lock mutex</li>
<li>If pool not empty: pop from stack, return</li>
<li>If pool empty:<ul>
<li><code>poolOnly</code> strategy: return null</li>
<li><code>always</code> strategy: allocate new message</li>
</ul>
</li>
<li>If pool empty, call alerter.alert(.pool_empty)</li>
<li>Unlock mutex</li>
</ul>
</li>
<li>
<p><strong>put(msg: <em>?</em>Message)  void</strong></p>
<ul>
<li>If msg is null: return (no-op)</li>
<li>Lock mutex</li>
<li>If pool closed: destroy message, unlock, return</li>
<li>If pool size &gt;= maxPoolMsgs: destroy message, unlock, return</li>
<li>Push to stack (msg.next = first; first = msg)</li>
<li>Increment current size</li>
<li>Call alerter.alert(.pool_freed) if was empty</li>
<li>Unlock mutex</li>
</ul>
</li>
<li>
<p><strong>inform()  void</strong></p>
<ul>
<li>If pool was empty and now has messages: alert engine</li>
<li>If pool is full: alert engine (backpressure)</li>
</ul>
</li>
</ol>
<p><strong>Configuration:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Options {
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    initialPoolMsgs: ?u16 = 16   // Pre-allocated messages
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    maxPoolMsgs: ?u16 = 64       // Pool capacity limit
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>}
</span></code></pre></div></p>
<p><strong>Why LIFO?</strong></p>
<ul>
<li><strong>Cache locality:</strong> Recently returned messages likely still hot in CPU cache</li>
<li><strong>Simpler code:</strong> No tail pointer needed</li>
<li><strong>Performance:</strong> Fewer memory accesses</li>
</ul>
<p><strong>Backpressure Mechanism:</strong></p>
<ul>
<li>When pool empty  send <code>.pool_empty</code> status to application</li>
<li>Application can:<ul>
<li>Add messages to pool dynamically</li>
<li>Use <code>.poolOnly</code> strategy and handle nulls</li>
<li>Reduce send rate</li>
</ul>
</li>
<li>Pool full  excess messages destroyed (prevents unbounded growth)</li>
</ul>
<h3 id="memory-ownership-model">Memory Ownership Model</h3>
<p><strong>Rule 1: Pool Owns All Messages</strong></p>
<ul>
<li>Messages come from pool</li>
<li>Messages return to pool</li>
<li>Application borrows messages temporarily</li>
</ul>
<p><strong>Rule 2: Ownership Transfer via Pointer-to-Pointer</strong></p>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kr">var</span><span class="w"> </span><span class="n">msg</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">Message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ampe</span><span class="p">.</span><span class="n">get</span><span class="p">(.</span><span class="n">always</span><span class="p">);</span><span class="w">  </span><span class="c1">// Ownership: Application</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">defer</span><span class="w"> </span><span class="n">ampe</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span><span class="w">                        </span><span class="c1">// Ensures return to pool</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">chnls</span><span class="p">.</span><span class="n">enqueueToPeer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span><span class="w">           </span><span class="c1">// Ownership: Engine (msg becomes null)</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="c1">// msg is now NULL - cannot use after this point</span>
</span></code></pre></div>
<p><strong>Rule 3: defer Pattern Mandatory</strong></p>
<ul>
<li>Every <code>get()</code> must have corresponding <code>defer put()</code></li>
<li>Ensures cleanup even on error paths</li>
<li>Prevents message leaks</li>
</ul>
<p><strong>Rule 4: Received Messages Also Use Pool</strong></p>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kr">var</span><span class="w"> </span><span class="n">received</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">Message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">chnls</span><span class="p">.</span><span class="n">waitReceive</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">defer</span><span class="w"> </span><span class="n">ampe</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">received</span><span class="p">);</span><span class="w">  </span><span class="c1">// Return to pool when done</span>
</span></code></pre></div>
<h3 id="allocator-usage">Allocator Usage</h3>
<p><strong>Principle:</strong> Allocator-agnostic, user provides</p>
<p><strong>Main Allocator</strong> <strong>GeneralPurposeAllocator (GPA)</strong></p>
<p><strong>Allocation Points:</strong>
1. Reactor creation: <code>Reactor.Create(allocator, options)</code>
2. Message creation: <code>Message.create(allocator)</code> (if pool empty with <code>.always</code>)
3. ActiveChannels: Pre-allocates nodes for removed-channels buffer
4. TextHeaders/Body: Dynamic growth using <code>Appendable</code> buffer</p>
<p><strong>Deallocation Points:</strong>
1. Reactor destruction: <code>Reactor.Destroy()</code>
2. Message destruction: When pool full or closed
3. ChannelGroup destruction: Cleanup mailboxes</p>
<hr />
<h2 id="16-concurrency-model">1.6 Concurrency Model</h2>
<h3 id="threading-model">Threading Model</h3>
<p><strong>Single Reactor Thread + Multiple Application Threads</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>                     Application Threads                          
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>                  
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>   Thread 1    Thread 2    Thread 3    Thread N           
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>                  
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>                                                              
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        get/put      get/put      get/put      get/put        
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>        enqueue      enqueue      enqueue      enqueue        
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>                       
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>                                                                 
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>                                                                 
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>                                      
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>                  Pool (Mutex)                                  
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>                  Mailboxes                                     
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>                  ActiveChannels (Mutex)                        
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>                                      
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>                                                                 
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>                                                                 
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>                                      
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>                   Notifier                                     
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>                 (socketpair)                                   
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>                                      
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>                              
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>                    Reactor Thread                               
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>   
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>                Event Loop (Single-threaded)                   
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>    - Poll I/O events                                          
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>    - Process send queue                                       
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>    - Read/write sockets                                       
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    - Dispatch received messages                               
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>   
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>
</span></code></pre></div>
<h3 id="thread-safety-table">Thread-Safety Table</h3>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Thread-Safe?</th>
<th>Synchronization Mechanism</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ampe.get()</code></td>
<td> Yes</td>
<td>Pool.mutex</td>
</tr>
<tr>
<td><code>ampe.put()</code></td>
<td> Yes</td>
<td>Pool.mutex</td>
</tr>
<tr>
<td><code>ampe.create()</code></td>
<td> Yes</td>
<td>Reactor.crtMtx</td>
</tr>
<tr>
<td><code>ampe.destroy()</code></td>
<td> Yes</td>
<td>Reactor.crtMtx</td>
</tr>
<tr>
<td><code>chnls.enqueueToPeer()</code></td>
<td> Yes</td>
<td>Mailbox lock-free + Reactor.sndMtx</td>
</tr>
<tr>
<td><code>chnls.updateReceiver()</code></td>
<td> Yes</td>
<td>Mailbox lock-free</td>
</tr>
<tr>
<td><code>chnls.waitReceive()</code></td>
<td> <strong>NO</strong></td>
<td><strong>One thread only per ChannelGroup</strong></td>
</tr>
<tr>
<td>Reactor event loop</td>
<td> Internal</td>
<td>Reactor thread only</td>
</tr>
<tr>
<td>ActiveChannels registry</td>
<td> Yes</td>
<td>ActiveChannels.mutex</td>
</tr>
</tbody>
</table>
<h3 id="mutex-inventory">Mutex Inventory</h3>
<p><strong>1. Pool.mutex</strong></p>
<ul>
<li><strong>Purpose:</strong> Protect LIFO stack operations</li>
<li><strong>Scope:</strong> get(), put(), inform()</li>
<li><strong>Contention Risk:</strong> Moderate (all threads access)</li>
</ul>
<p><strong>2. Reactor.sndMtx</strong></p>
<ul>
<li><strong>Purpose:</strong> Protect send operations</li>
<li><strong>Scope:</strong> submitMsg(), internal send queue manipulation</li>
<li><strong>Contention Risk:</strong> Moderate (all enqueueToPeer calls)</li>
</ul>
<p><strong>3. Reactor.crtMtx</strong></p>
<ul>
<li><strong>Purpose:</strong> Protect create/destroy operations</li>
<li><strong>Scope:</strong> createChannelGroup(), destroyChannelGroup()</li>
<li><strong>Contention Risk:</strong> Low (infrequent operations)</li>
</ul>
<p><strong>4. ActiveChannels.mutex</strong></p>
<ul>
<li><strong>Purpose:</strong> Protect channel registry</li>
<li><strong>Scope:</strong> createChannel(), removeChannel(), check(), exists()</li>
<li><strong>Contention Risk:</strong> Moderate (channel lifecycle operations)</li>
</ul>
<p><strong>Lock Ordering (to prevent deadlock):</strong></p>
<ul>
<li>Never hold multiple mutexes simultaneously</li>
<li>Each mutex protects independent data structure</li>
<li>No nested locking patterns observed</li>
</ul>
<h3 id="mailbox-communication">Mailbox Communication</h3>
<p><strong>Intrusive Mailbox (from external <code>mailbox</code> library):</strong></p>
<ul>
<li><strong>Producer-Consumer:</strong> Lock-free intrusive queue</li>
<li><strong>Operations:</strong><ul>
<li><code>send(msg)</code>: Enqueue message (may block if full)</li>
<li><code>receive(timeout)</code>: Dequeue message (blocks until available or timeout)</li>
<li><code>close()</code>: Shutdown mailbox, return all messages</li>
</ul>
</li>
</ul>
<p><strong>Dual Mailbox Pattern (MchnGroup):</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>MchnGroup {
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    msgs: [2]MSGMailBox
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    //    [0] = Send queue (app  engine)
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    //    [1] = Receive queue (engine  app)
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>}
</span></code></pre></div></p>
<p><strong>Flow:</strong></p>
<ol>
<li>Application calls <code>enqueueToPeer(&amp;msg)</code>  puts msg in <code>msgs[0]</code>  notifies reactor</li>
<li>Reactor reads from <code>msgs[0]</code>  processes  sends on socket</li>
<li>Reactor receives from socket  puts msg in <code>msgs[1]</code>  notifies application</li>
<li>Application calls <code>waitReceive()</code>  blocks on <code>msgs[1]</code>  returns received msg</li>
</ol>
<h3 id="atomic-operations">Atomic Operations</h3>
<p><strong>Usage (recipes/services.zig):</strong></p>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">cancel</span><span class="o">:</span><span class="w"> </span><span class="n">Atomic</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">setCancel</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="k">cancel</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">monotonic</span><span class="p">)</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">wasCancelled</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">cancel</span><span class="p">.</span><span class="n">load</span><span class="p">(.</span><span class="n">monotonic</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Memory Ordering:</strong></p>
<ul>
<li><code>.monotonic</code>: Sufficient for simple flags (no dependent loads)</li>
<li>No <code>.seq_cst</code> needed (no multi-variable synchronization)</li>
</ul>
<hr />
<h2 id="17-io-and-networking">1.7 I/O and Networking</h2>
<h3 id="non-blocking-socket-pattern">Non-Blocking Socket Pattern</h3>
<p><strong>Socket Creation (Skt.zig):</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>1. Create socket: socket(AF_INET/AF_UNIX, SOCK_STREAM, 0)
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>2. Set non-blocking: fcntl(fd, F_SETFL, O_NONBLOCK)
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>3. Set SO_REUSEADDR (TCP only)
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>4. Bind (server) or Connect (client)
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>5. Return Skt wrapper struct
</span></code></pre></div></p>
<p><strong>Skt Structure:</strong>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">Skt</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="n">channel_number</span><span class="o">:</span><span class="w"> </span><span class="n">ChannelNumber</span><span class="w">  </span><span class="c1">// Associated channel</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="n">sktFd</span><span class="o">:</span><span class="w"> </span><span class="n">SocketFd</span><span class="w">                </span><span class="c1">// OS socket file descriptor</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="n">listener</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w">                 </span><span class="c1">// true = listener, false = connected</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="n">connecting</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w">               </span><span class="c1">// true during TCP handshake</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="c1">// ... OS-specific fields</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="poller-abstraction-pollerzig">Poller Abstraction (poller.zig)</h3>
<p>Implemented using <em>tagged union</em>.</p>
<p>Current implementation based on  <em>poll()</em>.</p>
<h3 id="protocol-wire-format">Protocol Wire Format</h3>
<p><strong>Message Serialization:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>                     Wire Message                          
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a> BinaryHeader (16 bytes, big-endian)                       
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>   ch_num | proto | status | msg_id | thl | bl           
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>   (u16)  | (u8)  | (u8)   | (u64)  |(u16)|(u16)         
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a> TextHeaders (thl bytes)                                   
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>  Key1: Value1\r\n                                         
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>  Key2: Value2\r\n                                         
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>  \r\n                                                     
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a> Body (bl bytes)                                           
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>  [arbitrary binary data]                                  
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
</span></code></pre></div></p>
<p><strong>Serialization (toBytes):</strong>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">fn</span><span class="w"> </span><span class="n">toBytes</span><span class="p">(</span><span class="n">bhdr</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">BinaryHeader</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="c1">// Convert each field to big-endian</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">writeBigEndianU16</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">bhdr</span><span class="p">.</span><span class="n">channel_number</span><span class="p">)</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bhdr</span><span class="p">.</span><span class="n">proto</span><span class="p">.</span><span class="n">toByte</span><span class="p">()</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bhdr</span><span class="p">.</span><span class="n">status</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="n">writeBigEndianU64</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">..</span><span class="mi">12</span><span class="p">],</span><span class="w"> </span><span class="n">bhdr</span><span class="p">.</span><span class="n">message_id</span><span class="p">)</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="n">writeBigEndianU16</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">..</span><span class="mi">14</span><span class="p">],</span><span class="w"> </span><span class="n">bhdr</span><span class="p">.</span><span class="err">@</span><span class="s">&quot;&lt;thl&gt;&quot;</span><span class="p">)</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="n">writeBigEndianU16</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">14</span><span class="p">..</span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="n">bhdr</span><span class="p">.</span><span class="err">@</span><span class="s">&quot;&lt;bl&gt;&quot;</span><span class="p">)</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>Deserialization (fromBytes):</strong></p>
<ul>
<li>Reverse process: read big-endian bytes  populate struct fields</li>
</ul>
<h3 id="socket-io-state-machine">Socket I/O State Machine</h3>
<pre class="mermaid"><code>stateDiagram-v2
    [*] --&gt; Idle: Socket created
    Idle --&gt; Connecting: connect() called (client)
    Idle --&gt; Listening: listen() called (server)

    Connecting --&gt; WaitWritable: EINPROGRESS
    WaitWritable --&gt; Connected: Writable event

    Listening --&gt; WaitReadable: accept() would block
    WaitReadable --&gt; AcceptReady: Readable event
    AcceptReady --&gt; NewClient: accept() succeeds

    Connected --&gt; ReadReady: Data available
    ReadReady --&gt; Reading: recv() in progress
    Reading --&gt; ReadComplete: All data read
    ReadComplete --&gt; Connected: Ready for more

    Connected --&gt; WriteReady: Can write
    WriteReady --&gt; Writing: send() in progress
    Writing --&gt; WriteComplete: All data sent
    WriteComplete --&gt; Connected: Ready for more

    Reading --&gt; WouldBlock: EAGAIN/EWOULDBLOCK
    Writing --&gt; WouldBlock: EAGAIN/EWOULDBLOCK
    WouldBlock --&gt; Connected: Re-register with poller

    Reading --&gt; Error: Socket error
    Writing --&gt; Error: Socket error
    Connected --&gt; Error: Peer closed

    Error --&gt; Closed: Close socket
    Closed --&gt; [*]</code></pre>
<h3 id="tcp-vs-unix-domain-sockets">TCP vs Unix Domain Sockets</h3>
<p><strong>TCP Configuration:</strong>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">TCPServerConfigurator</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="n">address</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w">  </span><span class="c1">// IP address (e.g., &quot;0.0.0.0&quot;, &quot;127.0.0.1&quot;)</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">port</span><span class="o">:</span><span class="w"> </span><span class="kt">u16</span><span class="w">            </span><span class="c1">// Port number</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="p">}</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="n">TCPClientConfigurator</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="n">address</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w">  </span><span class="c1">// Server IP</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="n">port</span><span class="o">:</span><span class="w"> </span><span class="kt">u16</span><span class="w">            </span><span class="c1">// Server port</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>UDS Configuration:</strong>
<div class="language-zig highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">UDSServerConfigurator</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="n">path</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w">     </span><span class="c1">// File path (e.g., &quot;/tmp/tofu.sock&quot;)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="p">}</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">UDSClientConfigurator</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">    </span><span class="n">path</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w">     </span><span class="c1">// Same path as server</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>Differences:</strong></p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>TCP</th>
<th>Unix Domain Sockets</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Address</strong></td>
<td>IP:Port</td>
<td>File path</td>
</tr>
<tr>
<td><strong>Scope</strong></td>
<td>Network-wide</td>
<td>Local machine only</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Slower (network stack)</td>
<td>Faster (kernel bypass)</td>
</tr>
<tr>
<td><strong>Use Case</strong></td>
<td>Distributed systems</td>
<td>IPC (Inter-Process Communication)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="18-os-dependencies">1.8 OS Dependencies</h2>
<h3 id="posix-system-calls">POSIX System Calls</h3>
<p><strong>Core I/O:</strong></p>
<ul>
<li><code>socket()</code> - Create socket endpoint</li>
<li><code>bind()</code> - Bind socket to address</li>
<li><code>listen()</code> - Mark socket as listener</li>
<li><code>accept()</code> - Accept incoming connection</li>
<li><code>connect()</code> - Initiate connection</li>
<li><code>send()</code> / <code>recv()</code> - Send/receive data</li>
<li><code>close()</code> - Close file descriptor</li>
<li><code>fcntl()</code> - Set non-blocking mode (F_SETFL, O_NONBLOCK)</li>
<li><code>setsockopt()</code> - Set socket options (SO_REUSEADDR)</li>
</ul>
<p><strong>Polling:</strong></p>
<ul>
<li>Linux: <code>poll()</code></li>
</ul>
<p><strong>Notifier:</strong></p>
<ul>
<li><code>socketpair()</code> - Create connected socket pair (AF_UNIX, SOCK_STREAM)</li>
<li>Alternative on Linux: Unix domain socket pair</li>
</ul>
<p><strong>Threading:</strong></p>
<ul>
<li><code>std.Thread.spawn()</code> - Spawn thread (uses pthread internally on POSIX)</li>
<li><code>std.Thread.Mutex</code> - Mutex (pthread_mutex)</li>
<li><code>std.Thread.Semaphore</code> - Semaphore (pthread_cond + pthread_mutex)</li>
<li><code>std.Thread.Atomic</code> - Atomic operations (compiler intrinsics)</li>
</ul>
<h3 id="external-library-dependencies">External Library Dependencies</h3>
<p><strong>From build.zig.zon:</strong></p>
<ol>
<li>
<p><strong>nats</strong> (https://github.com/g41797/nats.zig)</p>
<ul>
<li>Provides: <code>Appendable</code> (dynamically growing buffer)</li>
<li>Used for: Message body, TextHeaders storage</li>
<li>Provides: <code>Formatter</code> (string formatting utilities)</li>
</ul>
</li>
<li>
<p><strong>mailbox</strong> (https://github.com/g41797/mailbox)</p>
<ul>
<li>Provides: <code>MailBoxIntrusive</code> (intrusive lock-free queue)</li>
<li>Used for: Dual mailboxes in MchnGroup (send/receive queues)</li>
</ul>
</li>
<li>
<p><strong>temp</strong> (https://github.com/g41797/temp.zig)</p>
<ul>
<li>Provides: Temporary file path generation</li>
<li>Used for: UDS testing (create temp socket paths)</li>
</ul>
</li>
<li>
<p><strong>datetime</strong> (https://github.com/g41797/datetime)</p>
<ul>
<li>Provides: Date/time handling utilities</li>
<li>Used for: Timestamps (not core to message passing)</li>
</ul>
</li>
</ol>
<p><strong>Critical Dependencies for Porting:</strong></p>
<ul>
<li><code>Appendable</code>: Dynamic buffer implementation needed</li>
<li><code>MailBoxIntrusive</code>: Lock-free intrusive queue needed (or equivalent sync primitive)</li>
</ul>
<hr />
<h2 id="19-entity-catalog-and-responsibilities">1.9 Entity Catalog and Responsibilities</h2>
<h3 id="core-entities">Core Entities</h3>
<table>
<thead>
<tr>
<th>Entity</th>
<th>File</th>
<th>Lines</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Reactor</strong></td>
<td><code>src/ampe/Reactor.zig</code></td>
<td>~967</td>
<td>Event loop, I/O multiplexing, message routing</td>
</tr>
<tr>
<td><strong>Pool</strong></td>
<td><code>src/ampe/Pool.zig</code></td>
<td>~200</td>
<td>Message pool management, backpressure</td>
</tr>
<tr>
<td><strong>MchnGroup</strong></td>
<td><code>src/ampe/MchnGroup.zig</code></td>
<td>~229</td>
<td>ChannelGroup implementation, dual mailboxes</td>
</tr>
<tr>
<td><strong>ActiveChannels</strong></td>
<td><code>src/ampe/channels.zig</code></td>
<td>~341</td>
<td>Channel registry, random allocation, validation</td>
</tr>
<tr>
<td><strong>Message</strong></td>
<td><code>src/message.zig</code></td>
<td>~600</td>
<td>Message structure, serialization, validation</td>
</tr>
<tr>
<td><strong>BinaryHeader</strong></td>
<td><code>src/message.zig</code></td>
<td>~150</td>
<td>16-byte header, big-endian conversion</td>
</tr>
<tr>
<td><strong>Notifier</strong></td>
<td><code>src/ampe/Notifier.zig</code></td>
<td>~200</td>
<td>Socketpair notification mechanism</td>
</tr>
<tr>
<td><strong>Poller</strong></td>
<td><code>src/ampe/poller.zig</code></td>
<td>~400</td>
<td>OS-specific I/O polling abstraction</td>
</tr>
<tr>
<td><strong>Skt</strong></td>
<td><code>src/ampe/Skt.zig</code></td>
<td>~300</td>
<td>Socket wrapper, connection state</td>
</tr>
<tr>
<td><strong>IntrusiveQueue</strong></td>
<td><code>src/ampe/IntrusiveQueue.zig</code></td>
<td>~105</td>
<td>Generic intrusive linked list queue</td>
</tr>
<tr>
<td><strong>Configurator</strong></td>
<td><code>src/configurator.zig</code></td>
<td>~200</td>
<td>TCP/UDS configuration helpers</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td><code>src/status.zig</code></td>
<td>~150</td>
<td>AmpeStatus/AmpeError, conversions</td>
</tr>
</tbody>
</table>
<h3 id="public-api-interfaces">Public API Interfaces</h3>
<table>
<thead>
<tr>
<th>Interface</th>
<th>File</th>
<th>Methods</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Ampe</strong></td>
<td><code>src/ampe.zig</code></td>
<td><code>get</code>, <code>put</code>, <code>create</code>, <code>destroy</code>, <code>getAllocator</code></td>
<td>Engine interface</td>
</tr>
<tr>
<td><strong>ChannelGroup</strong></td>
<td><code>src/ampe.zig</code></td>
<td><code>enqueueToPeer</code>, <code>waitReceive</code>, <code>updateReceiver</code></td>
<td>Message exchange interface</td>
</tr>
</tbody>
</table>
<h3 id="recipe-patterns">Recipe Patterns</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>EchoService</strong></td>
<td><code>recipes/services.zig</code></td>
<td>Simple request-response echo</td>
</tr>
<tr>
<td><strong>EchoClient</strong></td>
<td><code>recipes/services.zig</code></td>
<td>Client pattern with reconnection</td>
</tr>
<tr>
<td><strong>MultiHomed</strong></td>
<td><code>recipes/MultiHomed.zig</code></td>
<td>Multiple listeners (TCP + UDS) on one thread</td>
</tr>
<tr>
<td><strong>Cookbook Examples</strong></td>
<td><code>recipes/cookbook.zig</code></td>
<td>40+ examples covering all patterns</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="110-architectural-flows">1.10 Architectural Flows</h2>
<h3 id="flow-1-server-startup-and-client-connection">Flow 1: Server Startup and Client Connection</h3>
<pre class="mermaid"><code>sequenceDiagram
    participant App as Application Thread
    participant Pool as Message Pool
    participant Reactor as Reactor Thread
    participant OS as Operating System

    Note over App: Server Startup
    App-&gt;&gt;Pool: get(.always)
    Pool--&gt;&gt;App: welcomeMsg
    App-&gt;&gt;App: Configure: WelcomeRequest&lt;br/&gt;address="0.0.0.0", port=8080
    App-&gt;&gt;Reactor: enqueueToPeer(&amp;welcomeMsg)
    Note over App: welcomeMsg becomes NULL

    Reactor-&gt;&gt;OS: socket(AF_INET, SOCK_STREAM)
    OS--&gt;&gt;Reactor: listener_fd
    Reactor-&gt;&gt;OS: bind(listener_fd, 0.0.0.0:8080)
    Reactor-&gt;&gt;OS: listen(listener_fd)
    Reactor-&gt;&gt;Reactor: Register listener_fd with poller

    Reactor-&gt;&gt;Pool: get(.always)
    Pool--&gt;&gt;Reactor: responseMsg
    Reactor-&gt;&gt;Reactor: Set WelcomeResponse&lt;br/&gt;status=success, ch#=listener_channel
    Reactor-&gt;&gt;App: receiveMailbox.send(responseMsg)

    App-&gt;&gt;Reactor: waitReceive()
    Reactor--&gt;&gt;App: responseMsg (WelcomeResponse)
    Note over App: Server is listening

    Note over App: Client Startup (different app)
    App-&gt;&gt;Pool: get(.always)
    Pool--&gt;&gt;App: helloMsg
    App-&gt;&gt;App: Configure: HelloRequest&lt;br/&gt;address="127.0.0.1", port=8080
    App-&gt;&gt;Reactor: enqueueToPeer(&amp;helloMsg)

    Reactor-&gt;&gt;OS: socket(AF_INET, SOCK_STREAM)
    OS--&gt;&gt;Reactor: client_fd
    Reactor-&gt;&gt;OS: connect(client_fd, 127.0.0.1:8080)
    Note over Reactor: Non-blocking: returns EINPROGRESS
    Reactor-&gt;&gt;Reactor: Register client_fd for write

    Note over Reactor: Later: poller returns writable
    Reactor-&gt;&gt;Reactor: Connection established
    Reactor-&gt;&gt;Reactor: Generate random channel#
    Reactor-&gt;&gt;OS: send(client_fd, HelloRequest bytes)

    Note over OS: Server side
    OS-&gt;&gt;Reactor: accept() on listener_fd
    Reactor-&gt;&gt;OS: accept(listener_fd)
    OS--&gt;&gt;Reactor: new_client_fd
    Reactor-&gt;&gt;Reactor: Generate random channel#
    Reactor-&gt;&gt;Reactor: Register new_client_fd for read

    Note over Reactor: Later: poller returns readable
    Reactor-&gt;&gt;OS: recv(new_client_fd)
    OS--&gt;&gt;Reactor: HelloRequest bytes
    Reactor-&gt;&gt;Reactor: Parse message
    Reactor-&gt;&gt;Pool: get(.always)
    Pool--&gt;&gt;Reactor: incomingMsg
    Reactor-&gt;&gt;Reactor: Populate incomingMsg with HelloRequest
    Reactor-&gt;&gt;App: receiveMailbox.send(incomingMsg)

    App-&gt;&gt;Reactor: waitReceive()
    Reactor--&gt;&gt;App: incomingMsg (HelloRequest from client)

    App-&gt;&gt;App: Process HelloRequest
    App-&gt;&gt;App: Create HelloResponse
    App-&gt;&gt;Reactor: enqueueToPeer(&amp;response)

    Reactor-&gt;&gt;OS: send(new_client_fd, HelloResponse bytes)

    Note over App,OS: Connection established. Ready for regular messages.</code></pre>
<h3 id="flow-2-message-exchange-request-response">Flow 2: Message Exchange (Request-Response)</h3>
<pre class="mermaid"><code>sequenceDiagram
    participant Client as Client App
    participant CPool as Client Pool
    participant CReactor as Client Reactor
    participant Net as Network
    participant SReactor as Server Reactor
    participant SPool as Server Pool
    participant Server as Server App

    Client-&gt;&gt;CPool: get(.always)
    CPool--&gt;&gt;Client: requestMsg
    Client-&gt;&gt;Client: Set: role=request, ch#=123&lt;br/&gt;message_id=0 (will be generated)
    Client-&gt;&gt;Client: Add headers, body
    Client-&gt;&gt;CReactor: enqueueToPeer(&amp;requestMsg)
    Note over Client: requestMsg is NULL now

    CReactor-&gt;&gt;CReactor: Generate message_id=456
    CReactor-&gt;&gt;CReactor: Serialize to bytes
    CReactor-&gt;&gt;Net: send() on socket for ch#123

    Net-&gt;&gt;SReactor: recv() detects readable
    SReactor-&gt;&gt;SReactor: Read BinaryHeader (16 bytes)
    SReactor-&gt;&gt;SReactor: Read TextHeaders + Body
    SReactor-&gt;&gt;SReactor: Parse into Message struct

    SReactor-&gt;&gt;SPool: get(.always)
    SPool--&gt;&gt;SReactor: receivedMsg
    SReactor-&gt;&gt;SReactor: Copy parsed data to receivedMsg
    SReactor-&gt;&gt;Server: receiveMailbox.send(receivedMsg)

    Server-&gt;&gt;SReactor: waitReceive()
    SReactor--&gt;&gt;Server: receivedMsg
    Server-&gt;&gt;Server: Process request&lt;br/&gt;(message_id=456, ch#=123)

    Server-&gt;&gt;Server: Reuse receivedMsg for response
    Server-&gt;&gt;Server: Set: role=response&lt;br/&gt;message_id=456 (same as request)
    Server-&gt;&gt;SReactor: enqueueToPeer(&amp;receivedMsg)

    SReactor-&gt;&gt;SReactor: Serialize response
    SReactor-&gt;&gt;Net: send() on socket for ch#123

    Net-&gt;&gt;CReactor: recv() detects readable
    CReactor-&gt;&gt;CReactor: Parse response
    CReactor-&gt;&gt;CPool: get(.always)
    CPool--&gt;&gt;CReactor: responseMsg
    CReactor-&gt;&gt;CReactor: Copy parsed data to responseMsg
    CReactor-&gt;&gt;Client: receiveMailbox.send(responseMsg)

    Client-&gt;&gt;CReactor: waitReceive()
    CReactor--&gt;&gt;Client: responseMsg (message_id=456)
    Client-&gt;&gt;Client: Match response to request&lt;br/&gt;via message_id
    Client-&gt;&gt;CPool: put(&amp;responseMsg)</code></pre>
<h3 id="flow-3-pool-empty-handling">Flow 3: Pool Empty Handling</h3>
<pre class="mermaid"><code>sequenceDiagram
    participant App as Application
    participant Pool as Message Pool
    participant Reactor as Reactor

    App-&gt;&gt;Pool: get(.always)
    Note over Pool: Pool is empty!
    Pool-&gt;&gt;Pool: Allocate new message
    Pool-&gt;&gt;Reactor: alerter.alert(.pool_empty)
    Pool--&gt;&gt;App: newMsg (newly allocated)

    App-&gt;&gt;App: Configure message
    App-&gt;&gt;Reactor: enqueueToPeer(&amp;newMsg)

    Note over Reactor: Process message, send, receive response

    Reactor-&gt;&gt;Pool: get(.always)
    Note over Pool: Still empty!
    Pool-&gt;&gt;Pool: Allocate another message
    Pool-&gt;&gt;Reactor: alerter.alert(.pool_empty)
    Pool--&gt;&gt;Reactor: responseMsg (newly allocated)

    Reactor-&gt;&gt;Reactor: Populate with response data
    Reactor-&gt;&gt;Reactor: Set status=pool_empty&lt;br/&gt;origin=engine
    Reactor-&gt;&gt;App: receiveMailbox.send(responseMsg)

    App-&gt;&gt;Reactor: waitReceive()
    Reactor--&gt;&gt;App: responseMsg
    App-&gt;&gt;App: Check status: pool_empty detected

    App-&gt;&gt;App: Create 3 new messages
    loop 3 times
        App-&gt;&gt;Pool: Message.create(allocator)
        Pool-&gt;&gt;Pool: Store message
        App-&gt;&gt;Pool: put(&amp;msg)
    end

    Pool-&gt;&gt;Reactor: alerter.alert(.pool_freed)
    Note over Pool: Pool now has 3 messages

    App-&gt;&gt;Pool: get(.always)
    Note over Pool: Pool has messages
    Pool--&gt;&gt;App: msg (from pool, not allocated)
    Note over App: Normal operation resumes</code></pre>
<h3 id="flow-4-inter-thread-communication">Flow 4: Inter-Thread Communication</h3>
<pre class="mermaid"><code>sequenceDiagram
    participant AppThread as Application Thread
    participant SendMbox as Send Mailbox [0]
    participant Notifier as Notifier (socketpair)
    participant Reactor as Reactor Thread
    participant RecvMbox as Receive Mailbox [1]

    Note over AppThread,RecvMbox: Message Send Flow
    AppThread-&gt;&gt;SendMbox: msgs[0].send(message)
    SendMbox-&gt;&gt;Notifier: Wake reactor
    Notifier-&gt;&gt;Reactor: Readable on receiver socket
    Reactor-&gt;&gt;SendMbox: msgs[0].receive()
    SendMbox--&gt;&gt;Reactor: message
    Reactor-&gt;&gt;Reactor: Process &amp; send on socket

    Note over AppThread,RecvMbox: Message Receive Flow
    Reactor-&gt;&gt;Reactor: Receive from socket
    Reactor-&gt;&gt;RecvMbox: msgs[1].send(message)
    RecvMbox-&gt;&gt;AppThread: (waitReceive unblocks)
    AppThread-&gt;&gt;RecvMbox: msgs[1].receive()
    RecvMbox--&gt;&gt;AppThread: message</code></pre>
<hr />












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../conversation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Conversation">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Conversation
              </div>
            </div>
          </a>
        
        
          
          <a href="../tofu-implementation-review/" class="md-footer__link md-footer__link--next" aria-label="Next: Review">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Review
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 g41797
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.annotate", "content.tabs.link", "navigation.top", "navigation.instant", "navigation.path", "navigation.footer", "header.autohide", "content.tooltips", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../js/scroll-sync.js"></script>
      
        <script src="../../js/hero-theme-toggle.js"></script>
      
        <script src="../../js/open_in_new_tab.js"></script>
      
    
  </body>
</html>